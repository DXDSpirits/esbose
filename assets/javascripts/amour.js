!function(){if($(".view").css("min-height",$(window).height()),navigator.userAgent.match(/IEMobile\/10\.0/)){var a=document.createElement("style");a.appendChild(document.createTextNode("@-ms-viewport{width:auto!important}")),document.getElementsByTagName("head")[0].appendChild(a)}else $.getScript("http://esbose.oatpie.com/assets/javascripts/fix-ie.js");var b=new FastClick(document.body);$("body").on("focus","textarea",function(){null!=b&&(b.destroy(),b=null)}),$("body").on("blur","textarea",function(){null==b&&(b=new FastClick(document.body))}),window.location.origin||(window.location.origin=window.location.protocol+"//"+window.location.hostname+(window.location.port?":"+window.location.port:""));var c={version:"1.0",APIHost:BOSE_CONFIGS.APIHost,CDNURL:BOSE_CONFIGS.CDNURL};_.extend(c,Backbone.Events);{var d=(c.EventAggregator=function(){var a=function(){};return a.extend=Backbone.Model.extend,_.extend(a.prototype,Backbone.Events),a}(),c.Model=Backbone.Model.extend({initialize:function(){this.initModel&&this.initModel()},url:function(){var a=Backbone.Model.prototype.url.call(this);return a+("/"==a.charAt(a.length-1)?"":"/")}})),e=c.Collection=Backbone.Collection.extend({model:d,initialize:function(){this.initCollection&&this.initCollection()},parse:function(a){return null!=a.results?(this.count=a.count,this.previous=a.previous,this.next=a.next,a.results):a},fetchNext:function(a){var a=a||{};this.next&&(a.url=this.next,this.fetch(a))},fetchPrev:function(a){var a=a||{};this.previous&&(a.url=this.previous,this.fetch(a))}}),f=c.View=Backbone.View.extend({initialize:function(a){this.initView&&this.initView(a||{})},renderTemplate:function(a,b){var b=b||_.result(this,"template")||"",a=this.mixinTemplateHelpers(a);return this.$el.html(Mustache.render(b,a)),this.$el.find("img[data-src]").addBack("img[data-src]").each(function(){c.loadImage($(this),$(this).data("src"))}),this.$el.find(".img[data-bg-src]").addBack(".img[data-bg-src]").each(function(){c.loadBgImage($(this),$(this).data("bg-src"))}),this},mixinTemplateHelpers:function(a){var a=a||{};return _.extend(a,_.result(this,"templateHelpers"))}}),g=c.ModelView=f.extend({listenToModel:function(){this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"hide",this.hide)},initView:function(a){this.model=this.model||new d,this.listenToModel(),this.initModelView&&this.initModelView(a||{})},setModel:function(a){this.stopListening(this.model),this.model=a,this.listenToModel()},hide:function(){this.remove()},serializeData:function(){return this.model?this.model.toJSON():{}},render:function(){return this.renderTemplate(this.serializeData())}});c.CollectionView=f.extend({ModelView:g,listenToCollection:function(){this.listenTo(this.collection,"reset",this.addAll),this.listenTo(this.collection,"add",this.addOne),this.listenTo(this.collection,"remove",this.removeOne)},initView:function(a){a=a||{},this.reverse=a.reverse===!0,this.collection=this.collection||new e,this.listenToCollection(),this.initCollectionView&&this.initCollectionView(a)},setCollection:function(a){this.stopListening(this.collection),this.collection=a,this.listenToCollection()},renderItem:function(a){var b=new this.ModelView({model:a});return b.render().el},removeOne:function(a){a.trigger("hide")},addOne:function(a){var b=this.reverse?"prepend":"append";this.$el[b](this.renderItem(a))},addAll:function(a,b){if(b&&b.previousModels&&_.each(b.previousModels,function(a){a.trigger("hide")}),this.collection){var c=this.collection.reduce(function(a,b){return a.concat(this.renderItem(b))},[],this);this.$el.html(this.reverse?c.reverse():c)}},render:function(){return this.addAll(),this}})}c.isWeixin=/MicroMessenger/i.test(navigator.userAgent),c.isMobile=/iPhone|Android|iPad|Windows Phone/i.test(navigator.userAgent),c.storage=new function(){this.set=function(a,b){localStorage.setItem(a,b)},this.get=function(a){return localStorage.getItem(a)},this.del=function(a){localStorage.removeItem(a)};try{localStorage.setItem("TEST_LOCALSTORAGE",1)}catch(a){alert("您的浏览器可能开启了“无痕(Private)浏览”，可能需要多次输入用户名和密码以保持登录状态"),this.vault={},this.set=function(a,b){this.vault[a]=b},this.get=function(a){return this.vault[a]},this.del=function(a){this.vault[a]=null}}},c.openWindow=function(a){window.open(a,"_self","location=no")},c.imageFullpath=function(a){return/^http:\/\//.test(a)?a:c.CDNURL+a},c.loadImage=function(a,b,d){if(b){d=d||{};var e=new Image,f=c.imageFullpath(b);e.onload=function(){a.attr("src",f)},e.src=f}},c.loadBgImage=function(a,b,d){if(b){d=d||{},a.css("background-image","url("+c.CDNURL+"images/loading.gif)");var e=new Image,f=c.imageFullpath(b);e.onload=function(){a.removeClass("img-loading"),a.css("background-image","url("+f+")")},a.addClass("img-loading"),e.src=f}},c.Models={},c.Collections={};var h={getData:function(a){var b=this.get("data");return _.isObject(b)||(b={}),null!=a?b[a]:b},setData:function(a,b){null!=a&&(_.isObject(this.attributes.data)||(this.attributes.data={}),_.isObject(a)?_.extend(this.attributes.data,a):this.attributes.data[a]=b)}};c.Models.StoryEvent=c.Model.extend({urlRoot:c.APIHost+"/sites/storyevent/"}).extend(h),c.Collections.StoryEvents=c.Collection.extend({url:c.APIHost+"/sites/storyevent/",model:c.Models.StoryEvent}),c.Models.Story=c.Model.extend({urlRoot:c.APIHost+"/sites/story/",initModel:function(){this.storyEvents=new c.Collections.StoryEvents(this.get("storyEvents")),this.on("change:storyEvents",function(){this.storyEvents.set(this.get("storyEvents"))},this)},getStoryEvent:function(a){return this.storyEvents.findWhere({name:a})},getStoryEventData:function(a,b){var c=this.storyEvents.findWhere({name:a});return c.getData(b)},updateStoryEvent:function(a,b){var c=this.storyEvents.findWhere({name:a});c.setData(b),c.save()}}).extend(h),c.Collections.Stories=c.Collection.extend({url:c.APIHost+"/sites/story/",model:c.Models.Story}),c.Models.Section=c.Model.extend({urlRoot:null}).extend(h),c.Collections.Sections=c.Collection.extend({url:null,model:c.Models.StoryEvent}),c.Models.Schema=c.Model.extend({idAttribute:"name",urlRoot:c.APIHost+"/sites/schema/",initModel:function(){this.sections=new c.Collections.Sections(this.get("sections")),this.on("change:sections",function(){this.sections.set(this.get("sections"))},this)},getSection:function(a){return this.sections.findWhere({name:a})}}).extend(h),c.Collections.Schemas=c.Collection.extend({url:c.APIHost+"/sites/schema/",model:c.Models.Schema}),c.Models.User=c.Model.extend({urlRoot:c.APIHost+"/users/user/",initModel:function(){},parse:function(a){return _.isArray(a)?a[0]:a},login:function(a,b){this.clear().set(a),b=b||{},b.url=c.APIHost+"/api-token-auth/";var d=b.success;b.success=function(a,b,e){c.TokenAuth.set(b.token),d&&d(a,b,e),a.trigger("login")},this.save({},b)},register:function(a,b){this.clear().set(a),this.save({},b)}});var i=function(){_.extend(c.ajax={},Backbone.Events),$(document).ajaxStart(function(){c.ajax.trigger("start")}),$(document).ajaxStop(function(){c.ajax.trigger("stop")});var a,b,d=1e3;c.ajax.on("start",function(){clearTimeout(a),clearTimeout(b),$("#apploader").removeClass("invisible")}),c.ajax.on("stop",function(){a=setTimeout(function(){$("#apploader").addClass("invisible"),d=1e3},d)}),c.ajax.on("error",function(){$("#apploader .ajax-error").removeClass("hidden"),b=setTimeout(function(){$("#apploader .ajax-error").addClass("hidden")},d=2500)})},j=function(){$("img[data-src]").each(function(){var a=$(this).data("src");a&&c.loadImage($(this),a)}),$(".img[data-bg-src]").each(function(){var a=$(this).data("bg-src");a&&c.loadBgImage($(this),a)})};i(),j(),window.Amour=c}();